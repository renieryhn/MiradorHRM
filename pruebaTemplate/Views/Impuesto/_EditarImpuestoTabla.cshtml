@model PlanillaPM.Models.ImpuestoTablaListaYModelo
@using PlanillaPM.Models;

@* <style>
    .hidden-col {
        display: none;
    }
</style> *@



<div class="modal-header">
    <h4 class="modal-title">Editar Tabla de Impuestos</h4>
    <button class="btn btn-info" id="add"><span class="glyphicon glyphicon-plus-sign"></span>Agregar Nuevo Elemento</button>
</div>

<div class="modal-body">
    <!-- Campos para editar ImpuestoTabla -->
    <input type="hidden" asp-for="ImpuestoTabla.IdImpuesto" value="@Model.ImpuestoTabla.IdImpuesto" />
    <input type="hidden" asp-for="ImpuestoTabla.IdImpuestoTabla" value="@Model.ImpuestoTabla.IdImpuestoTabla" />

    <form asp-controller="ImpuestoTabla" asp-action="Edit" method="post">
        <div id="resultados" class="table-responsive table-striped table-sm ">
            <table class="table table-striped projects " cellspacing="0" data-toggle="table" id="table-list">
                <thead class="thead-light">
                    <tr>
                        <th>@Html.DisplayNameFor(model => model.ImpuestoTabla.IdImpuestoTabla)</th>
                        <th>@Html.DisplayNameFor(model => model.ImpuestoTabla.Desde)</th>
                        <th>@Html.DisplayNameFor(model => model.ImpuestoTabla.Hasta)</th>
                        <th>@Html.DisplayNameFor(model => model.ImpuestoTabla.Monto)</th>
                        <th>@Html.DisplayNameFor(model => model.ImpuestoTabla.Porcentaje)</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.ListaImpuestoTabla)
                    {

                        <tr>
                            <td class="readonly">@item.IdImpuestoTabla</td>
                            <td>@item.Desde</td>
                            <td>@item.Hasta</td>
                            <td>@item.Monto</td>
                            <td>@item.Porcentaje</td>

                        </tr>
                    }
                </tbody>
            </table>

        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
    </form>
</div>



<script>
    "use strict";
    //Global variables
    var params = null;
    var colsEdi = null;
    var newColHtml = '<div class="btn-group pull-right">' +
        '<button id="bEdit" type="button" class="btn btn-sm btn-default" onclick="rowEdit(this);">' +
        '<i class="fas fa-pencil-alt"></i>' +
        '</button>' +
        '<button id="bElim" type="button" class="btn btn-sm btn-default" onclick="rowElim(this);">' +
        '<i class="fas fa-trash"></i>' +
        '</button>' +
        '<button id="bAcep" type="button" class="btn btn-sm btn-default" style="display:none;" onclick="rowAcep(this);">' +
        '<i class="fas fa-check"></i>' +
        '</button>' +
        '<button id="bCanc" type="button" class="btn btn-sm btn-default" style="display:none;" onclick="rowCancel(this);">' +
        '<i class="fas fa-times"></i>' +
        '</button>' +
        '</div>';

    var colEdicHtml = '<td name="buttons">' + newColHtml + '</td>';

    $.fn.SetEditable = function (options) {
        var defaults = {
            columnsEd: "1,2,4,5",     //Index to editable columns. If null all td editables. Ex.: "1,2,3,4,5"
            $addButton: null,        //Jquery object of "Add" button
            onEdit: function () { },   //Called after edition
            onBeforeDelete: function () { }, //Called before deletion
            onDelete: function () { }, //Called after deletion
            onAdd: function () { }     //Called when added a new row
        };
        params = $.extend(defaults, options);
        this.find('thead tr').append('<th name="buttons">Acciones</th>');
        this.find('tbody tr').append(colEdicHtml);
        var $tabedi = this;   //Read reference to the current table, to resolve "this" here.
        //Process "addButton" parameter
        if (params.$addButton != null) {
            //Se proporcionó parámetro
            params.$addButton.click(function () {
                rowAddNew($tabedi.attr("id"));
            });
        }
        //Process "columnsEd" parameter
        if (params.columnsEd != null) {
            //Extract fields
            colsEdi = params.columnsEd.split(',');
        }
    };

    function IterarCamposEdit($cols, tarea) {
        var n = 0;
        $cols.each(function () {
            n++;
            if ($(this).attr('name') == 'buttons') return;  //excluye columna de botones
            if (!EsEditable(n - 1)) return;   //no es campo editable
            tarea($(this));
        });

        function EsEditable(idx) {
            if (colsEdi == null) {  //no se definió
                return true;  //todas son editables
            } else {  //hay filtro de campos
                for (var i = 0; i < colsEdi.length; i++) {
                    if (idx == colsEdi[i]) return true;
                }
                return false;  //no se encontró
            }
        }
    }

 

    function FijModoNormal(but) {
        $(but).parent().find('#bAcep').hide();
        $(but).parent().find('#bCanc').hide();
        $(but).parent().find('#bEdit').show();
        $(but).parent().find('#bElim').show();
        var $row = $(but).parents('tr');  //accede a la fila
        $row.attr('id', '');  //quita marca
    }

    function FijModoEdit(but) {
        $(but).parent().find('#bAcep').show();
        $(but).parent().find('#bCanc').show();
        $(but).parent().find('#bEdit').hide();
        $(but).parent().find('#bElim').hide();
        var $row = $(but).parents('tr');  //accede a la fila
        $row.attr('id', 'editing');  //indica que está en edición
    }

    function ModoEdicion($row) {
        return $row.attr('id') == 'editing';
    }

    function rowAcep(but) {
        var $row = $(but).parents('tr');  // accede a la fila
        var $cols = $row.find('td');  // lee campos
        if (!ModoEdicion($row)) return;  // Ya está en edición

        // Recopila los datos de la fila
        var data = {};
        IterarCamposEdit($cols, function ($td, index) {
            var input = $td.find('input');
            if (input.length > 0) {
                var fieldName = input.attr('name');
                data[fieldName] = input.val();
            }
        });

        // Muestra la data en consola
        console.log("Data a enviar:");
        for (var prop in data) {
            if (data.hasOwnProperty(prop)) {
                console.log(prop + ": " + data[prop]);
            }
        }

        var isEdit = data['IdImpuestoTabla'] && data['IdImpuestoTabla'].trim() !== '';

        // Determina la URL a llamar
        var url;
        if (isEdit) {
            url = '/ImpuestoTabla/Edit';
        } else {
            url = '/ImpuestoTabla/Create';
        }

        // Llama a la función AJAX
        $.ajax({
            url: url,
            type: 'POST',
            data: JSON.stringify(data),
            contentType: 'application/json; charset=utf-8',
            success: function (response) {
                // Actualiza la UI o muestra un mensaje de éxito
                $cols.each(function () {
                    var cont = $(this).find('input').val(); // lee contenido del input
                    $(this).html(cont);  // fija contenido y elimina controles
                });
                FijModoNormal(but);
                params.onEdit($row);
            },
            error: function (xhr, status, error) {
                // Maneja el error
                console.error("Error al guardar los cambios: " + error);
            }
        });
    }



    function rowCancel(but) {
        var $row = $(but).parents('tr');  //accede a la fila
        var $cols = $row.find('td');  //lee campos
        if (!ModoEdicion($row)) return;  //Ya está en edición
        IterarCamposEdit($cols, function ($td) {
            var cont = $td.find('div').html(); //lee contenido del div
            $td.html(cont);  //fija contenido y elimina controles
        });
        FijModoNormal(but);
    }

    function rowEdit(but) {  //Inicia la edición de una fila
        var $row = $(but).parents('tr');  //accede a la fila
        var $cols = $row.find('td');  //lee campos
        if (ModoEdicion($row)) return;  //Ya está en edición
        IterarCamposEdit($cols, function ($td) {
            var cont = $td.html(); //lee contenido
            var div = '<div style="display: none;">' + cont + '</div>';  //guarda contenido
            var input = '<input class="form-control input-sm" name="' + $td.attr('data-field') + '" value="' + cont + '">';
            $td.html(div + input);  //fija contenido
        });
        FijModoEdit(but);
    }

    function rowElim(but) {  //Elimina la fila actual
        var $row = $(but).parents('tr');  //accede a la fila
        params.onBeforeDelete($row);
        $row.remove();
        params.onDelete();
    }

    function rowAddNew(tabId) {  //Agrega fila a la tabla indicada.
        var $tab_en_edic = $("#" + tabId);  //Table to edit
        var $filas = $tab_en_edic.find('tbody tr');
        if ($filas.length == 0) {
            var $row = $tab_en_edic.find('thead tr');  //encabezado
            var $cols = $row.find('th');  //lee campos
            var htmlDat = '';
            $cols.each(function () {
                if ($(this).attr('name') == 'buttons') {
                    htmlDat = htmlDat + colEdicHtml;  //agrega botones
                } else {
                    htmlDat = htmlDat + '<td data-field="' + $(this).attr('data-field') + '"></td>';
                }
            });
            $tab_en_edic.find('tbody').append('<tr>' + htmlDat + '</tr>');
        } else {
            var $ultFila = $tab_en_edic.find('tr:last');
            $ultFila.clone().appendTo($ultFila.parent());
            $ultFila = $tab_en_edic.find('tr:last');
            var $cols = $ultFila.find('td');  //lee campos
            $cols.each(function () {
                if ($(this).attr('name') == 'buttons') {
                    //Es columna de botones
                } else {
                    $(this).html('');  //limpia contenido
                }
            });
        }
        params.onAdd();
        return false;  // Evita el comportamiento predeterminado del botón
    }

    function TableToCSV(tabId, separator) {  //Convierte tabla a CSV
        var datFil = '';
        var tmp = '';
        var $tab_en_edic = $("#" + tabId);  //Table source
        $tab_en_edic.find('tbody tr').each(function () {
            if (ModoEdicion($(this))) {
                $(this).find('#bAcep').click();  //acepta edición
            }
            var $cols = $(this).find('td');  //lee campos
            datFil = '';
            $cols.each(function () {
                if ($(this).attr('name') == 'buttons') {
                    //Es columna de botones
                } else {
                    datFil = datFil + $(this).html() + separator;
                }
            });
            if (datFil != '') {
                datFil = datFil.substr(0, datFil.length - separator.length);
            }
            tmp = tmp + datFil + '\n';
        });
        return tmp;
    }

    //apply
        $("#table-list").SetEditable({
            $addButton: $('#add')
        });
   
</script>



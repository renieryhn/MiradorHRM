@model PlanillaPM.Models.EmpleadoHorario

@{
    ViewData["Title"] = "Edit";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="container-fluid">
    <form asp-action="Edit">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h3 class="card-title">Editar Horario del Empleado</h3>
            </div>

            <div class="card-body">
                <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
                <input type="hidden" asp-for="IdEmpleadoHorario" />

                <!-- Sección de Información Básica -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="IdEmpleado" class="control-label font-weight-bold">Empleado</label>
                            <select asp-for="IdEmpleado" class="form-control select2bs4" asp-items="ViewBag.IdEmpleado">
                                <option value="">Seleccione un empleado...</option>
                            </select>
                            <span asp-validation-for="IdEmpleado" class="text-danger small"></span>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="IdHorarioBase" class="control-label font-weight-bold">Horario Base</label>
                            <select id="IdHorarioBase" name="IdHorarioBase" asp-for="IdHorarioBase" class="form-control select2bs4" asp-items="ViewBag.IdHorarioBase">
                                <option value="">Seleccione un horario base...</option>
                            </select>
                            <span asp-validation-for="IdHorarioBase" class="text-danger small"></span>
                        </div>
                    </div>
                </div>

                <!-- Días de Trabajo -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="form-check form-switch ms-4">
                            <input class="form-check-input" type="checkbox" asp-for="IndSabado" id="sabadoCheck">
                            <label class="form-check-label font-weight-bold" for="sabadoCheck">Trabaja Sábado</label>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="form-check form-switch ms-4">
                            <input class="form-check-input" type="checkbox" asp-for="IndDomingo" id="domingoCheck">
                            <label class="form-check-label font-weight-bold" for="domingoCheck">Trabaja Domingo</label>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="form-check form-switch ms-4">
                            <input class="form-check-input" type="checkbox" asp-for="Activo" id="activoCheck">
                            <label class="form-check-label font-weight-bold" for="activoCheck">Activo</label>
                        </div>
                    </div>
                </div>


                <!-- Horario Semanal -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h4 class="card-title mb-0">Horario Semanal</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Día</th>
                                        <th colspan="2" class="text-center">Hora Laboral</th>
                                        <th colspan="2" class="text-center">Receso</th>
                                        <th>Horas Diarias</th>
                                    </tr>
                                    <tr>
                                        <th></th>
                                        <th>Entrada</th>
                                        <th>Salida</th>
                                        <th>Inicio</th>
                                        <th>Fin</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Lunes -->
                                    <tr id="lunesRow">
                                        <td class="font-weight-bold">Lunes</td>
                                        <td><input asp-for="LunDesde" class="form-control timepicker" type="time" /></td>
                                        <td><input asp-for="LunHasta" class="form-control timepicker" type="time" /></td>
                                        <td><input asp-for="LunRecesoDesde" class="form-control timepicker" type="time" /></td>
                                        <td><input asp-for="LunRecesoHasta" class="form-control timepicker" type="time" /></td>
                                        <td class="daily-hours font-weight-bold">
                                            <span class="hora-dia">@Model.HorasLunes</span>
                                            <input type="hidden" name="HorasLunes" class="hora-dia-hidden" value="@Model.HorasLunes" />
                                        </td>
                                    </tr>
                                    <!-- Martes -->
                                    <tr id="martesRow">
                                        <td class="font-weight-bold">Martes</td>
                                        <td><input asp-for="MarDesde" class="form-control timepicker" type="time" /></td>
                                        <td><input asp-for="MarHasta" class="form-control timepicker" type="time" /></td>
                                        <td><input asp-for="MarRecesoDesde" class="form-control timepicker" type="time" /></td>
                                        <td><input asp-for="MarRecesoHasta" class="form-control timepicker" type="time" /></td>                                        
                                        <td class="daily-hours font-weight-bold">
                                            <span class="hora-dia">@Model.HorasMartes</span>
                                            <input type="hidden" name="HorasMartes" class="hora-dia-hidden" value="@Model.HorasMartes" />
                                        </td>
                                    </tr>
                                    <!-- Miércoles -->
                                    <tr id="miercolesRow">
                                        <td class="font-weight-bold">Miércoles</td>
                                        <td><input asp-for="MieDesde" class="form-control timepicker" type="time" /></td>
                                        <td><input asp-for="MieHasta" class="form-control timepicker" type="time" /></td>
                                        <td><input asp-for="MieRecesoDesde" class="form-control timepicker" type="time" /></td>
                                        <td><input asp-for="MieRecesoHasta" class="form-control timepicker" type="time" /></td>
                                        <td class="daily-hours font-weight-bold">
                                            <span class="hora-dia">@Model.HorasMiercoles</span>
                                            <input type="hidden" name="HorasMiercoles" class="hora-dia-hidden" value="@Model.HorasMiercoles" />
                                        </td>
                                    </tr>
                                    <!-- Jueves -->
                                    <tr id="juevesRow">
                                        <td class="font-weight-bold">Jueves</td>
                                        <td><input asp-for="JueDesde" class="form-control timepicker" type="time" /></td>
                                        <td><input asp-for="JueHasta" class="form-control timepicker" type="time" /></td>
                                        <td><input asp-for="JueRecesoDesde" class="form-control timepicker" type="time" /></td>
                                        <td><input asp-for="JueRecesoHasta" class="form-control timepicker" type="time" /></td>
                                        <td class="daily-hours font-weight-bold">
                                            <span class="hora-dia">@Model.HorasJueves</span>
                                            <input type="hidden" name="HorasJueves" class="hora-dia-hidden" value="@Model.HorasJueves" />
                                        </td>
                                    </tr>
                                    <!-- Viernes -->
                                    <tr id="viernesRow">
                                        <td class="font-weight-bold">Viernes</td>
                                        <td><input asp-for="VieDesde" class="form-control timepicker" type="time" /></td>
                                        <td><input asp-for="VieHasta" class="form-control timepicker" type="time" /></td>
                                        <td><input asp-for="VieRecesoDesde" class="form-control timepicker" type="time" /></td>
                                        <td><input asp-for="VieRecesoHasta" class="form-control timepicker" type="time" /></td>
                                        <td class="daily-hours font-weight-bold">
                                            <span class="hora-dia">@Model.HorasViernes</span>
                                            <input type="hidden" name="HorasViernes" class="hora-dia-hidden" value="@Model.HorasViernes" />
                                        </td>

                                    </tr>
                                    <!-- Sábado -->
                                    <tr id="sabadoRow" style="@(Model.IndSabado ? "" : "display:none;")">
                                        <td class="font-weight-bold">Sábado</td>
                                        <td><input asp-for="SabDesde" class="form-control timepicker" type="time" /></td>
                                        <td><input asp-for="SabHasta" class="form-control timepicker" type="time" /></td>
                                        <td><input asp-for="SabRecesoDesde" class="form-control timepicker" type="time" /></td>
                                        <td><input asp-for="SabRecesoHasta" class="form-control timepicker" type="time" /></td>
                                        <td class="daily-hours font-weight-bold">
                                            <span class="hora-dia">@Model.HorasSabado</span>
                                            <input type="hidden" name="HorasSabado" class="hora-dia-hidden" value="@Model.HorasSabado" />
                                        </td>
                                    </tr>
                                    <!-- Domingo -->
                                    <tr id="domingoRow" style="@(Model.IndDomingo ? "" : "display:none;")">
                                        <td class="font-weight-bold">Domingo</td>
                                        <td><input asp-for="DomDesde" class="form-control timepicker" type="time" /></td>
                                        <td><input asp-for="DomHasta" class="form-control timepicker" type="time" /></td>
                                        <td><input asp-for="DomRecesoDesde" class="form-control timepicker" type="time" /></td>
                                        <td><input asp-for="DomRecesoHasta" class="form-control timepicker" type="time" /></td>
                                        <td class="daily-hours font-weight-bold">
                                            <span class="hora-dia">@Model.HorasDomingo</span>
                                            <input type="hidden" name="HorasDomingo" class="hora-dia-hidden" value="@Model.HorasDomingo" />
                                        </td>
                                    </tr>
                                </tbody>

                            </table>
                        </div>
                    </div>
                </div>

                <!-- Resumen -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="card h-100">
                            <div class="card-header bg-light">
                                <h4 class="card-title mb-0">Resumen</h4>
                            </div>
                            <div class="card-body d-flex align-items-center justify-content-center">
                                <div class="form-group text-center">
                                    <label asp-for="TotalHorasSemana" class="control-label font-weight-bold">Total Horas por Semana</label>
                                    <input name="TotalHorasSemana" id="TotalHorasSemana" asp-for="TotalHorasSemana" class="form-control text-center font-weight-bold" style="font-size: 1.5rem;" readonly />
                                    <span asp-validation-for="TotalHorasSemana" class="text-danger small"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-footer text-right">
                <button type="submit" class="btn btn-primary mr-2">
                    <i class="fas fa-save mr-1"></i> Guardar Horario
                </button>
                <a asp-action="Index" class="btn btn-secondary">
                    <i class="fas fa-arrow-left mr-1"></i> Regresar a la Lista
                </a>
            </div>
        </div>
    </form>
</div>



@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
               const diasSemana = [
            { nombre: "Lunes", prefijo: "Lun", rowId: "lunesRow" },
            { nombre: "Martes", prefijo: "Mar", rowId: "martesRow" },
            { nombre: "Miércoles", prefijo: "Mie", rowId: "miercolesRow" },
            { nombre: "Jueves", prefijo: "Jue", rowId: "juevesRow" },
            { nombre: "Viernes", prefijo: "Vie", rowId: "viernesRow" },
            { nombre: "Sábado", prefijo: "Sab", rowId: "sabadoRow" },
            { nombre: "Domingo", prefijo: "Dom", rowId: "domingoRow" }
        ];


        $(document).ready(function () {

            $('#IdEmpleado').on('change', function () {
                const idEmpleado = $(this).val();
                if (!idEmpleado) return;

                $.ajax({
                    url: `/EmpleadoHorario/ObtenerHorarioPorEmpleado`,
                    method: 'GET',
                    data: { idEmpleado: idEmpleado },
                    success: function (response) {
                        const horarioId = response.idHorario;
                        if (horarioId) {
                            $('#IdHorarioBase').val(horarioId).trigger('change');
                        } else {
                            toastr.warning("El empleado seleccionado no tiene clase activa o no tiene horario asignado.");
                        }
                    },
                    error: function (xhr, status, error) {
                        toastr.error("Error al obtener el horario del empleado. Verifique que el empleado y su clase estén activos.");
                        console.error("Error al obtener el horario por empleado:", error);
                    }
                });
            });

            $('#IdHorarioBase').on('change', function () {
                const id = $(this).val();
                if (!id) return;

                $.ajax({
                    url: `/EmpleadoHorario/ObtenerHorarioBase`,
                    method: 'GET',
                    data: { id: id },
                    success: function (data) {
                        if (!data || Object.keys(data).length === 0) {
                            toastr.warning("No se encontró información del horario seleccionado.");
                            return;
                        }

                        diasSemana.forEach(dia => {
                            if ((dia.prefijo === "Sab" && !data.IndSabado) || (dia.prefijo === "Dom" && !data.IndDomingo)) {
                                $(`#${dia.rowId}`).hide();
                            } else {
                                $(`#${dia.rowId}`).show();
                                $(`input[name='${dia.prefijo}Desde']`).val(data[`${dia.prefijo.toLowerCase()}Desde`] ?? "");
                                $(`input[name='${dia.prefijo}Hasta']`).val(data[`${dia.prefijo.toLowerCase()}Hasta`] ?? "");
                                $(`input[name='${dia.prefijo}RecesoDesde']`).val(data[`${dia.prefijo.toLowerCase()}RecesoDesde`] ?? "12:00");
                                $(`input[name='${dia.prefijo}RecesoHasta']`).val(data[`${dia.prefijo.toLowerCase()}RecesoHasta`] ?? "13:00");
                            }
                        });

                        actualizarTotales();
                    },
                    error: function (xhr, status, error) {
                        toastr.error("No fue posible cargar el horario base. Asegúrese de que la clase del empleado y el horario estén activos.");
                        console.error("Error al obtener horario base:", error);
                    }
                });
            });


                   $(document).on('input change', 'input[type="time"]', function () {
            actualizarTotales();
        });


            function calcularHoras(entrada, salida, recesoInicio, recesoFin) {
                if (!entrada || !salida) return 0;
                const toMinutes = t => {
                    const [h, m] = t.split(":").map(Number);
                    return h * 60 + m;
                };
                let inicio = toMinutes(entrada);
                let fin = toMinutes(salida);
                let total = fin - inicio;
                if (recesoInicio && recesoFin) {
                    let rIni = toMinutes(recesoInicio);
                    let rFin = toMinutes(recesoFin);
                    total -= (rFin - rIni);
                }
                return total > 0 ? total : 0;
            }

            function formatoHHMM(minutos) {
                const h = Math.floor(minutos / 60);
                const m = minutos % 60;
                return `${h}:${m.toString().padStart(2, "0")}`;
            }

            function actualizarTotales() {
                let totalSemana = 0;
                diasSemana.forEach(dia => {
                    const entrada = $(`input[name='${dia.prefijo}Desde']`).val();
                    const salida = $(`input[name='${dia.prefijo}Hasta']`).val();
                    const recesoInicio = $(`input[name='${dia.prefijo}RecesoDesde']`).val();
                    const recesoFin = $(`input[name='${dia.prefijo}RecesoHasta']`).val();
                    const minutos = calcularHoras(entrada, salida, recesoInicio, recesoFin);
                    totalSemana += minutos;
                    // $(`#${dia.rowId} .daily-hours`).text(formatoHHMM(minutos));
                           $(`#${dia.rowId} .hora-dia`).text(formatoHHMM(minutos));            // Actualiza el texto visible
                           $(`#${dia.rowId} .hora-dia-hidden`).val(formatoHHMM(minutos));
                        });
                $('input[name="TotalHorasSemana"]').val(formatoHHMM(totalSemana));
            }

         

            $('#sabadoCheck, #domingoCheck').on('change', function () {
            const esSabado = this.id === 'sabadoCheck';
            const activo = this.checked;
            const prefijo = esSabado ? 'Sab' : 'Dom';
            const rowId = esSabado ? 'sabadoRow' : 'domingoRow';

            if (activo) {
                // Mostrar la fila
                $(`#${rowId}`).show();

                // Si los campos están vacíos, pon valores por defecto
                const desde = $(`input[name='${prefijo}Desde']`);
                const hasta = $(`input[name='${prefijo}Hasta']`);
                const recesoDesde = $(`input[name='${prefijo}RecesoDesde']`);
                const recesoHasta = $(`input[name='${prefijo}RecesoHasta']`);

                if (!desde.val()) desde.val("00:00");
                if (!hasta.val()) hasta.val("00:00");
                if (!recesoDesde.val()) recesoDesde.val("00:00");
                if (!recesoHasta.val()) recesoHasta.val("00:00");
            } else {
                // Ocultar la fila y limpiar valores para evitar que cuenten
                $(`#${rowId}`).hide();
                $(`input[name='${prefijo}Desde']`).val("");
                $(`input[name='${prefijo}Hasta']`).val("");
                $(`input[name='${prefijo}RecesoDesde']`).val("");
                $(`input[name='${prefijo}RecesoHasta']`).val("");
            }

            // Recalcular
            actualizarTotales();
        });



            actualizarTotales();
        });
    </script>
}

